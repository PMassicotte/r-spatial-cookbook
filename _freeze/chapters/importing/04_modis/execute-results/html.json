{
  "hash": "ddddf3a5c80ed54e40f9530cdef8cc75",
  "result": {
    "engine": "knitr",
    "markdown": "# HDF5 and NetCDF Files from MODIS Ocean Color Data\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(rhdf5)\nlibrary(gdalraster)\nlibrary(stars)\nlibrary(terra)\nlibrary(rnaturalearth)\nlibrary(rnaturalearthdata)\n```\n:::\n\n\n\n\n\nIn these examples, we will use data from: [Earth data](https://oceandata.sci.gsfc.nasa.gov/directdataaccess/). This website provides direct access to ocean color data products from various satellite missions, including MODIS. You can find Level-3 binned and mapped data here.\n\n## L3BIN (Level-3 Binned Data) - HDF5\n\nLevel-3 binned (L3b) files are HDF5 files containing data that has been statistically processed and binned into spatial grids. The data is organized in layers, where each layer represents a different variable. These layers are stored in the `/level-3_binned_data` group within the HDF5 file. The `BinList` layer is particularly important, as it contains the bin information, such as the bin's coordinates and the bin's weights, which are crucial for proper interpretation of the data.\n\nIn R, these files can be read using the `rhdf5` package from [bioconductor](https://bioconductor.org/install/). If you haven't already, you'll need to install the `rhdf5` package. The following code shows how to install the package and then reads the `chlor_a` layer (chlorophyll-a concentration) from the file `A2016160.L3b_DAY_CHL.nc`\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nif (!require(\"BiocManager\", quietly = TRUE)) {\n  install.packages(\"BiocManager\")\n}\n\nBiocManager::install()\n\nBiocManager::install(\"rhdf5\")\n```\n:::\n\n\n\n\n\nThe `h5ls()` function will list all the layers included in the HDF5 file. This is useful for exploring the file's structure and identifying the available datasets.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfile <- here::here(\"data\", \"AQUA_MODIS.20160608.L3b.DAY.CHL.nc\")\nh5ls(file)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nDatatype: binDataType\nDatatype: binIndexType\nDatatype: binListType\n```\n\n\n:::\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|   |group                |name                |otype       |dclass   |dim     |\n|:--|:--------------------|:-------------------|:-----------|:--------|:-------|\n|0  |/                    |level-3_binned_data |H5I_GROUP   |         |        |\n|1  |/level-3_binned_data |BinIndex            |H5I_DATASET |COMPOUND |4320    |\n|2  |/level-3_binned_data |BinList             |H5I_DATASET |COMPOUND |2417047 |\n|3  |/level-3_binned_data |binDataDim          |H5I_DATASET |FLOAT    |0       |\n|4  |/level-3_binned_data |binIndexDim         |H5I_DATASET |FLOAT    |0       |\n|5  |/level-3_binned_data |binListDim          |H5I_DATASET |FLOAT    |0       |\n|6  |/level-3_binned_data |chlor_a             |H5I_DATASET |COMPOUND |2417047 |\n|7  |/                    |processing_control  |H5I_GROUP   |         |        |\n|8  |/processing_control  |input_parameters    |H5I_GROUP   |         |        |\n\n</div>\n:::\n:::\n\n\n\n\n\nFinally, use `h5read()` to open a specific layer:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- h5read(file, \"/level-3_binned_data/chlor_a\")\nhead(df)\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|       sum| sum_squared|\n|---------:|-----------:|\n| 0.1869691|  0.03495743|\n| 0.2829849|  0.05712159|\n| 0.4636284|  0.09679225|\n| 0.6681932|  0.13557214|\n| 0.5648066|  0.12085202|\n| 0.4852219|  0.09646683|\n\n</div>\n:::\n:::\n\n\n\n\n\nThe resulting data frame `df` will contain the binned chlorophyll-a data. The columns in this data frame represent:\n\n- `sum`: The sum of the chlorophyll-a values of all pixels within the bin.\n- `sum_squared`: The sum of the squared chlorophyll-a values within the bin. This can be used to calculate the variance or standard deviation of the data within the bin.\n\n::: {.callout-important}\n\n## Important: Applying Weights\n\nIt is crucial to understand that the observed values in the `sum` column need to be weighted to obtain the actual average chlorophyll-a concentration for each bin. The weights, representing the relative contribution of each pixel to the bin, are stored in the `BinList` layer.\n\n:::\n\nTo apply the weights, read the `BinList` layer and divide the `sum` column by the `weights` column:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbins <- h5read(file, \"/level-3_binned_data/BinList\")\n\ndf[[\"sum\"]] <- df[[\"sum\"]] / bins[[\"weights\"]]\n\nhead(df)\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|       sum| sum_squared|\n|---------:|-----------:|\n| 0.1869691|  0.03495743|\n| 0.2001005|  0.05712159|\n| 0.2073409|  0.09679225|\n| 0.2014678|  0.13557214|\n| 0.2134768|  0.12085202|\n| 0.1980910|  0.09646683|\n\n</div>\n:::\n:::\n\n\n\n\n\nThe `df[[\"sum\"]]` column now contains the weighted average chlorophyll-a concentration for each bin. You can now perform further analysis or visualization with this data.\n\n## L3MAP (Level-3 Mapped Data) - NetCDF\n\nLevel-3 mapped (L3m) data represents geophysical variables projected onto a regular grid. These files are typically easier to visualize than L3b data because they are already in a gridded format.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfile <- here::here(\"data\", \"AQUA_MODIS.20160608.L3m.DAY.CHL.chlor_a.4km.nc\")\n\nr <- rast(file)\n\nr\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nclass       : SpatRaster \ndimensions  : 4320, 8640, 1  (nrow, ncol, nlyr)\nresolution  : 0.04166667, 0.04166667  (x, y)\nextent      : -180, 180, -90.00001, 90  (xmin, xmax, ymin, ymax)\ncoord. ref. : +proj=longlat +datum=WGS84 +no_defs \nsource      : AQUA_MODIS.20160608.L3m.DAY.CHL.chlor_a.4km.nc:chlor_a \nvarname     : chlor_a (Chlorophyll Concentration, OCI Algorithm) \nname        : chlor_a \nunit        : mg m^-3 \n```\n\n\n:::\n:::\n\n\n\n\n\nThis shows the raster's metadata, such as the number of layers, the number of rows and columns, the resolution, and the extent.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwm <- ne_countries(scale = \"medium\", returnclass = \"sf\")\n\nplot(wm[[\"geometry\"]], col = \"lightgray\", lwd = 0.5)\nplot(r, add = TRUE, col = terrain.colors(10L))\n```\n\n::: {.cell-output-display}\n![](04_modis_files/figure-html/unnamed-chunk-7-1.png)\n:::\n:::\n\n\n\n\n\n## L3BIN (Level-3 Binned Data) - hdf4\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfilename <- here::here(\"data\", \"MYD08_D3.A2003181.061.2018007232726.hdf\")\n\nsdss <- describe(filename, sds = TRUE, meta = FALSE, parse = FALSE)\nhead(sdss)\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n| id|name                                                                                                                                                      |var                             |desc                                                             | nrow| ncol| nlyr|\n|--:|:---------------------------------------------------------------------------------------------------------------------------------------------------------|:-------------------------------|:----------------------------------------------------------------|----:|----:|----:|\n|  1|HDF4_EOS:EOS_GRID:\"/media/work/projects/documentation/read_rs_product/data/MYD08_D3.A2003181.061.2018007232726.hdf\":mod08:Solar_Zenith_Mean               |Solar_Zenith_Mean               |[180x360] Solar_Zenith_Mean mod08 (16-bit integer)               |  180|  360|    1|\n|  2|HDF4_EOS:EOS_GRID:\"/media/work/projects/documentation/read_rs_product/data/MYD08_D3.A2003181.061.2018007232726.hdf\":mod08:Solar_Zenith_Standard_Deviation |Solar_Zenith_Standard_Deviation |[180x360] Solar_Zenith_Standard_Deviation mod08 (16-bit integer) |  180|  360|    1|\n|  3|HDF4_EOS:EOS_GRID:\"/media/work/projects/documentation/read_rs_product/data/MYD08_D3.A2003181.061.2018007232726.hdf\":mod08:Solar_Zenith_Minimum            |Solar_Zenith_Minimum            |[180x360] Solar_Zenith_Minimum mod08 (16-bit integer)            |  180|  360|    1|\n|  4|HDF4_EOS:EOS_GRID:\"/media/work/projects/documentation/read_rs_product/data/MYD08_D3.A2003181.061.2018007232726.hdf\":mod08:Solar_Zenith_Maximum            |Solar_Zenith_Maximum            |[180x360] Solar_Zenith_Maximum mod08 (16-bit integer)            |  180|  360|    1|\n|  5|HDF4_EOS:EOS_GRID:\"/media/work/projects/documentation/read_rs_product/data/MYD08_D3.A2003181.061.2018007232726.hdf\":mod08:Solar_Zenith_Pixel_Counts       |Solar_Zenith_Pixel_Counts       |[180x360] Solar_Zenith_Pixel_Counts mod08 (16-bit integer)       |  180|  360|    1|\n|  6|HDF4_EOS:EOS_GRID:\"/media/work/projects/documentation/read_rs_product/data/MYD08_D3.A2003181.061.2018007232726.hdf\":mod08:Solar_Azimuth_Mean              |Solar_Azimuth_Mean              |[180x360] Solar_Azimuth_Mean mod08 (16-bit integer)              |  180|  360|    1|\n\n</div>\n:::\n\n```{.r .cell-code}\nr <- rast(filename, 142L)\n\nplot(r)\n```\n\n::: {.cell-output-display}\n![](04_modis_files/figure-html/hdf4-1.png)\n:::\n:::\n",
    "supporting": [
      "04_modis_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}