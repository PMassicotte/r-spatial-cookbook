{
  "hash": "f37e7c4d78864cfc7b04905f0841e438",
  "result": {
    "engine": "knitr",
    "markdown": "# Filtering spatial data\n\nIn this tutorial, we will explore different methods to filter spatial data using the `sf` package in R. We will use the [Canadian Wind Turbine Database](https://open.canada.ca/data/en/dataset/79fdad93-9025-49ad-ba16-c26d718cc070) as our example dataset.\n\n## Filtering spatial data with `sf`\n\nThe Canadian Wind Turbine Database contains the geographic location and key technology details for wind turbines installed in Canada.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(sf)\nlibrary(DBI)\nlibrary(duckdb)\nlibrary(ggplot2)\nlibrary(rnaturalearth)\nlibrary(rnaturalearthdata)\n\n# URL to the wind turbine database\nurl <- \"/vsizip//vsicurl/https://ftp.cartes.canada.ca/pub/nrcan_rncan/Wind-energy_Energie-eolienne/wind_turbines_database/wind_turbine_database_en.gdb.zip\"\n\n# List layers in the dataset\nst_layers(url)\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|name         |geomtype |driver      | features| fields|crs                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |\n|:------------|:--------|:-----------|--------:|------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n|wind_turbine |Point    |OpenFileGDB |     7578|     17|NAD83 / Canada Atlas Lambert                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     , PROJCRS[\"NAD83 / Canada Atlas Lambert\",\n    BASEGEOGCRS[\"NAD83\",\n        DATUM[\"North American Datum 1983\",\n            ELLIPSOID[\"GRS 1980\",6378137,298.257222101,\n                LENGTHUNIT[\"metre\",1]]],\n        PRIMEM[\"Greenwich\",0,\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n        ID[\"EPSG\",4269]],\n    CONVERSION[\"Canada Atlas Lambert\",\n        METHOD[\"Lambert Conic Conformal (2SP)\",\n            ID[\"EPSG\",9802]],\n        PARAMETER[\"Latitude of false origin\",49,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8821]],\n        PARAMETER[\"Longitude of false origin\",-95,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8822]],\n        PARAMETER[\"Latitude of 1st standard parallel\",49,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8823]],\n        PARAMETER[\"Latitude of 2nd standard parallel\",77,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8824]],\n        PARAMETER[\"Easting at false origin\",0,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8826]],\n        PARAMETER[\"Northing at false origin\",0,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8827]]],\n    CS[Cartesian,2],\n        AXIS[\"(E)\",east,\n            ORDER[1],\n            LENGTHUNIT[\"metre\",1]],\n        AXIS[\"(N)\",north,\n            ORDER[2],\n            LENGTHUNIT[\"metre\",1]],\n    USAGE[\n        SCOPE[\"Transformation of coordinates at 5m level of accuracy.\"],\n        AREA[\"Canada - onshore and offshore - Alberta; British Columbia; Manitoba; New Brunswick; Newfoundland and Labrador; Northwest Territories; Nova Scotia; Nunavut; Ontario; Prince Edward Island; Quebec; Saskatchewan; Yukon.\"],\n        BBOX[38.21,-141.01,86.46,-40.73]],\n    ID[\"EPSG\",3978]] |\n\n</div>\n:::\n\n```{.r .cell-code}\n# Read the entire dataset\npts <- read_sf(url)\n\n# Load and transform Canada map\ncanada <- ne_countries(\n  scale = \"medium\",\n  returnclass = \"sf\",\n  country = \"Canada\"\n) |>\n  st_transform(crs = \"EPSG:3978\")\n\n# Plot the map with wind turbine points\nggplot() +\n  geom_sf(data = canada) +\n  geom_sf(data = pts, color = \"red\", size = 0.5)\n```\n\n::: {.cell-output-display}\n![](01_filtering_files/figure-html/unnamed-chunk-1-1.png)\n:::\n:::\n\n\n\n\n\n## Filtering spatial data with a bounding box\n\nTo avoid loading the entire dataset into memory, we can filter the data using a bounding box. This is particularly useful when working with large datasets. We can leverage the `wkt_filter` argument to filter spatial data and reduce the amount of data loaded into memory.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Read and transform the area of interest\narea <- read_sf(here::here(\"data\", \"area.geojson\")) |>\n  st_transform(crs = st_crs(pts))\n\n# Plot the map with the area of interest\nggplot() +\n  geom_sf(data = canada) +\n  geom_sf(data = area, color = \"blue\", fill = NA, linewidth = 1L) +\n  geom_sf(data = pts, color = \"red\", size = 0.5)\n```\n\n::: {.cell-output-display}\n![](01_filtering_files/figure-html/unnamed-chunk-2-1.png)\n:::\n:::\n\n\n\n\n\nInstead of loading the entire dataset into memory, we can filter the data using a bounding box.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Convert the area geometry to WKT\nwkt <- area |>\n  st_geometry() |>\n  st_as_text()\n\n# Read the filtered dataset using the bounding box\nfiltered <- read_sf(url, wkt_filter = wkt)\nfiltered[[\"Notes\"]] <- NULL\n\n\n# Plot the filtered data\nggplot() +\n  geom_sf(data = canada) +\n  geom_sf(data = area, color = \"blue\", fill = NA, linewidth = 1L) +\n  geom_sf(data = filtered, color = \"red\", size = 0.5)\n```\n\n::: {.cell-output-display}\n![](01_filtering_files/figure-html/unnamed-chunk-3-1.png)\n:::\n\n```{.r .cell-code}\n# Display the number of rows and the first few rows of the filtered data\nnrow(filtered)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 2032\n```\n\n\n:::\n\n```{.r .cell-code}\nhead(filtered)\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|Province_Territory |Project_Name | Total_Project_Capacity__MW_|Turbine_Identifier | Turbine_Number|Turbine_Number_in_Project | Turbine_Rated_Capacity__kW_| Rotor_Diameter__m_| Hub_Height__m_|Manufacturer |Model    | Commissioning| Latitude| Longitude|Data_Sources      |Basemap |Shape                    |\n|:------------------|:------------|---------------------------:|:------------------|--------------:|:-------------------------|---------------------------:|------------------:|--------------:|:------------|:--------|-------------:|--------:|---------:|:-----------------|:-------|:------------------------|\n|New Brunswick      |Burchill     |                          42|BRH1               |              1|1/10                      |                        4200|                141|            135|Enercon      |E141-4.2 |          2023| 45.15949| -66.19081|[70], [71], [910] |ESRI    |POINT (2225020 82296.21) |\n|New Brunswick      |Burchill     |                          42|BRH2               |              2|2/10                      |                        4200|                141|            135|Enercon      |E141-4.2 |          2023| 45.16434| -66.19718|[70], [71], [910] |ESRI    |POINT (2224322 82566.09) |\n|New Brunswick      |Burchill     |                          42|BRH3               |              3|3/10                      |                        4200|                141|            135|Enercon      |E141-4.2 |          2023| 45.16875| -66.20070|[70], [71], [910] |ESRI    |POINT (2223851 82890.97) |\n|New Brunswick      |Burchill     |                          42|BRH4               |              4|4/10                      |                        4200|                141|            135|Enercon      |E141-4.2 |          2023| 45.17307| -66.20036|[70], [71], [910] |ESRI    |POINT (2223662 83342.02) |\n|New Brunswick      |Burchill     |                          42|BRH5               |              5|5/10                      |                        4200|                141|            135|Enercon      |E141-4.2 |          2023| 45.17834| -66.19340|[70], [71], [910] |ESRI    |POINT (2223902 84120.34) |\n|New Brunswick      |Burchill     |                          42|BRH6               |              6|6/10                      |                        4200|                141|            135|Enercon      |E141-4.2 |          2023| 45.18281| -66.18900|[70], [71], [910] |ESRI    |POINT (2223997 84728.45) |\n\n</div>\n:::\n:::\n\n\n\n\n\n## Refining the filter with a user-defined SQL query\n\nWe can further refine our filter by using a user-defined query. For example, we can filter the wind turbines based on their rated capacity.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Display the range of turbine capacities\nrange(filtered[[\"Turbine_Rated_Capacity__kW_\"]])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1]    0 4200\n```\n\n\n:::\n:::\n\n\n\n\n\nTo refine the filter, we can use a custom query to select only the wind turbines with a rated capacity greater than 4000 kW. First, we need to identify the layer name to use in the SQL query.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# List layers in the dataset\nst_layers(url)\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|name         |geomtype |driver      | features| fields|crs                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |\n|:------------|:--------|:-----------|--------:|------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n|wind_turbine |Point    |OpenFileGDB |     7578|     17|NAD83 / Canada Atlas Lambert                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     , PROJCRS[\"NAD83 / Canada Atlas Lambert\",\n    BASEGEOGCRS[\"NAD83\",\n        DATUM[\"North American Datum 1983\",\n            ELLIPSOID[\"GRS 1980\",6378137,298.257222101,\n                LENGTHUNIT[\"metre\",1]]],\n        PRIMEM[\"Greenwich\",0,\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n        ID[\"EPSG\",4269]],\n    CONVERSION[\"Canada Atlas Lambert\",\n        METHOD[\"Lambert Conic Conformal (2SP)\",\n            ID[\"EPSG\",9802]],\n        PARAMETER[\"Latitude of false origin\",49,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8821]],\n        PARAMETER[\"Longitude of false origin\",-95,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8822]],\n        PARAMETER[\"Latitude of 1st standard parallel\",49,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8823]],\n        PARAMETER[\"Latitude of 2nd standard parallel\",77,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8824]],\n        PARAMETER[\"Easting at false origin\",0,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8826]],\n        PARAMETER[\"Northing at false origin\",0,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8827]]],\n    CS[Cartesian,2],\n        AXIS[\"(E)\",east,\n            ORDER[1],\n            LENGTHUNIT[\"metre\",1]],\n        AXIS[\"(N)\",north,\n            ORDER[2],\n            LENGTHUNIT[\"metre\",1]],\n    USAGE[\n        SCOPE[\"Transformation of coordinates at 5m level of accuracy.\"],\n        AREA[\"Canada - onshore and offshore - Alberta; British Columbia; Manitoba; New Brunswick; Newfoundland and Labrador; Northwest Territories; Nova Scotia; Nunavut; Ontario; Prince Edward Island; Quebec; Saskatchewan; Yukon.\"],\n        BBOX[38.21,-141.01,86.46,-40.73]],\n    ID[\"EPSG\",3978]] |\n\n</div>\n:::\n:::\n\n\n\n\n\nWe can use `wind_turbine` as the layer name in the custom query.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Read the filtered dataset with a custom query\nhigh_capacity <- read_sf(\n  url,\n  wkt_filter = wkt,\n  query = \"SELECT * FROM wind_turbine WHERE Turbine_Rated_Capacity__kW_ > 4000\"\n)\n\nhigh_capacity[[\"Notes\"]] <- NULL\n\n# Display the number of rows and the first few rows of the high capacity data\nnrow(high_capacity)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 10\n```\n\n\n:::\n\n```{.r .cell-code}\n# Plot the high capacity turbines\nggplot() +\n  geom_sf(data = canada) +\n  geom_sf(data = area, color = \"blue\", fill = NA, linewidth = 1L) +\n  geom_sf(data = high_capacity, color = \"red\", size = 0.5)\n```\n\n::: {.cell-output-display}\n![](01_filtering_files/figure-html/unnamed-chunk-6-1.png)\n:::\n:::\n\n\n\n\n\n## Filtering spatial data with DuckDB\n\nIn this section, we will demonstrate how to filter spatial data using DuckDB. DuckDB is an embedded analytical database that supports spatial extensions.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Connect to DuckDB\nconn <- dbConnect(duckdb())\n\n# Install and load the spatial extension\ndbSendQuery(conn, \"INSTALL spatial;\")\ndbSendQuery(conn, \"LOAD spatial;\")\n\n# Create a table with spatial data filtered by a bounding box\ndbSendQuery(\n  conn,\n  \"\n  CREATE\n  OR REPLACE TABLE t AS\n  SELECT\n   *,\n   ST_asWKB(geom) AS geometry\n  FROM\n   ST_Read('/vsis3/spatial-playground/gmw_v3.fgb', spatial_filter_box = {'min_x' : - 30, 'min_y' : 0, 'max_x' : - 50, 'max_y' : 45});\n  \"\n)\n\n# Read the filtered data from DuckDB\nread_sf(conn, query = \"SELECT * FROM t\", geometry_column = \"geometry\")\n\n# Read the filtered data with an additional computed area column\nread_sf(\n  conn,\n  query = \"SELECT *, ST_Area(geom) as area1 FROM t\",\n  geometry_column = \"geometry\"\n) |>\n  mutate(area2 = st_area(geometry), .after = area1)\n```\n:::\n",
    "supporting": [
      "01_filtering_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}