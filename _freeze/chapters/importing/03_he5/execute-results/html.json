{
  "hash": "afcf7db4263ddd4f39e5a8ebe06d4780",
  "result": {
    "engine": "knitr",
    "markdown": "# HE5 format\n\n\n\n\n\n::: {.cell}\n\n:::\n\n\n\n\n\nThis section demonstrates how to access and visualize sea ice concentration data stored in HE5 files, focusing on data from the AMSR-E/AMSR2 Unified L3 Daily 12.5 km dataset. We'll use R along with the `gdalraster`, `stars`, `terra`, and `sf` packages.\n\n::: {.callout-note}\n\n## Disclaimer\n\nThe code below is largely based/copied on the work of [mdsumner](https://gist.github.com/mdsumner/08265bac3faf1e4325e2d5a39a5f66bf).\n\n:::\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(gdalraster)\nlibrary(stars)\nlibrary(terra)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfile <- here::here(\"data\", \"AMSR_U2_L3_SeaIce12km_B04_20140314.he5\")\n```\n:::\n\n\n\n\n\nThe code leverages the NetCDF interface to access subdatasets within the HE5 file. This allows us to access the geolocation arrays, which is crucial for proper spatial referencing.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsub <- paste0(\"NetCDF:\", file, \":\")\nsds <- gdal_subdatasets(sub)\n\nsf::gdal_utils(\"info\", unlist(sds)[[30L]])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nDriver: netCDF/Network Common Data Format\nFiles: /media/LaCie16TB/work/projects/documentation/read_rs_product/data/AMSR_U2_L3_SeaIce12km_B04_20140314.he5\nSize is 608, 896\nMetadata:\n  /HDFEOS INFORMATION/NC_GLOBAL#HDFEOSVersion=HDFEOS_5.1.15\n  /HDFEOS/GRIDS/NpPolarGrid12km/Data Fields/SI_12km_NH_ICECON_DAY#comment=data value meaning: 0 -- Open Water, 110 -- missing/not calculated, 120 -- Land\n  /HDFEOS/GRIDS/NpPolarGrid12km/Data Fields/SI_12km_NH_ICECON_DAY#coordinates=lon lat\n  /HDFEOS/GRIDS/NpPolarGrid12km/Data Fields/SI_12km_NH_ICECON_DAY#long_name=Sea ice concentration daily average\n  /HDFEOS/GRIDS/NpPolarGrid12km/Data Fields/SI_12km_NH_ICECON_DAY#units=percent\n  NC_GLOBAL#Conventions=CF-1.6\n  NC_GLOBAL#history=This version of the Sea Ice processing code contains updates provided by the science team on September 16, 2019. For details on these updates, see the release notes provided in the DAP.\n  NC_GLOBAL#institution=NASA's AMSR Science Investigator-led Processing System (SIPS)\n  NC_GLOBAL#references=Please cite these data as: Markus, T., J. C. Comiso, and W. N. Meier. 2018. AMSR-E/AMSR2 Unified L3 Daily 12.5 km Brightness Temperatures, Sea Ice Concentration, Motion & Snow Depth Polar Grids, Version 1. [Indicate subset used]. Boulder, Colorado USA. NASA National Snow and Ice Data Center Distributed Active Archive Center. doi: https://doi.org/10.5067/RA1MIJOYPK3P.\n  NC_GLOBAL#source=satellite observation\n  NC_GLOBAL#title=AMSR-E/AMSR2 Unified L3 Daily 12.5 km Brightness Temperatures, Sea Ice Concentration, Motion & Snow Depth Polar Grids\nGeolocation:\n  SRS=GEOGCS[\"WGS 84\",DATUM[\"WGS_1984\",SPHEROID[\"WGS 84\",6378137,298.257223563,AUTHORITY[\"EPSG\",\"7030\"]],AUTHORITY[\"EPSG\",\"6326\"]],PRIMEM[\"Greenwich\",0,AUTHORITY[\"EPSG\",\"8901\"]],UNIT[\"degree\",0.0174532925199433,AUTHORITY[\"EPSG\",\"9122\"]],AXIS[\"Latitude\",NORTH],AXIS[\"Longitude\",EAST],AUTHORITY[\"EPSG\",\"4326\"]]\n  X_DATASET=NETCDF:\"/media/LaCie16TB/work/projects/documentation/read_rs_product/data/AMSR_U2_L3_SeaIce12km_B04_20140314.he5\":/HDFEOS/GRIDS/NpPolarGrid12km/lon\n  X_BAND=1\n  Y_DATASET=NETCDF:\"/media/LaCie16TB/work/projects/documentation/read_rs_product/data/AMSR_U2_L3_SeaIce12km_B04_20140314.he5\":/HDFEOS/GRIDS/NpPolarGrid12km/lat\n  Y_BAND=1\n  PIXEL_OFFSET=0\n  PIXEL_STEP=1\n  LINE_OFFSET=0\n  LINE_STEP=1\n  GEOREFERENCING_CONVENTION=PIXEL_CENTER\nCorner Coordinates:\nUpper Left  (    0.0,    0.0)\nLower Left  (    0.0,  896.0)\nUpper Right (  608.0,    0.0)\nLower Right (  608.0,  896.0)\nCenter      (  304.0,  448.0)\nBand 1 Block=608x1 Type=Int32, ColorInterp=Undefined\n  Unit Type: percent\n  Metadata:\n    NETCDF_VARNAME=SI_12km_NH_ICECON_DAY\n    coordinates=lon lat\n    long_name=Sea ice concentration daily average\n    units=percent\n    comment=data value meaning: 0 -- Open Water, 110 -- missing/not calculated, 120 -- Land\n```\n\n\n:::\n:::\n\n\n\n\n\nThe data needs to be transformed to a standard coordinate reference system (CRS). EPSG:3411 (NSIDC Sea Ice Polar Stereographic North) is commonly used for Northern Hemisphere sea ice data. The `gdal_utils()` function warps the data to this CRS and saves it to a temporary VRT (Virtual Raster) file. VRT files are useful because they act as a pointer to the original data without duplicating it, and allow for on-the-fly transformations.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndsn <- \"/vsimem/temp.vrt\"\n\nsf::gdal_utils(\n  \"warp\",\n  unlist(sds)[[30L]],\n  dsn,\n  options = c(\"-t_srs\", \"EPSG:3411\", \"-overwrite\")\n)\n```\n:::\n\n\n\n\n\nThe `rast()` function from the `terra` package is used to read the VRT file and create a `SpatRaster` object. This object contains the sea ice concentration data, which can be visualized using the `plot()` function.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nr <- rast(dsn)\nr\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nclass       : SpatRaster \ndimensions  : 897, 608, 1  (nrow, ncol, nlyr)\nresolution  : 12499.99, 12499.99  (x, y)\nextent      : -3850009, 3749985, -5356238, 5856254  (xmin, xmax, ymin, ymax)\ncoord. ref. : NSIDC Sea Ice Polar Stereographic North (EPSG:3411) \nsource      : temp.vrt \nname        : temp \n```\n\n\n:::\n\n```{.r .cell-code}\nplot(r)\n```\n\n::: {.cell-output-display}\n![](03_he5_files/figure-html/unnamed-chunk-6-1.png)\n:::\n:::\n\n\n\n\n\n## Using `describe()` to list available layers\n\n::: {.callout-warning}\n\nReading the data directly from the HE5 file with `terra` might not work correctly. You may get the message _can not find the spatial extent_. If this happens, you can use the `gdalraster` package to read the data and then convert it to a `SpatRaster` object or use recent versions of [gdal](https://gdal.org/) and [proj](https://proj.org/) libraries.\n\n:::\n\nThe installed version of `gdal` can be checked with the following command:\n\n\n\n\n\n::: {.cell}\n\n```{.bash .cell-code}\ngdalinfo --version\n```\n\n\n::: {.cell-output .cell-output-stdout}\n\n```\nGDAL 3.10.1, released 2025/01/08 (debug build)\n```\n\n\n:::\n:::\n\n\n\n\n\nIf you have a recent version of `gdal`, you read the data directly from the HE5 file with the `terra` package.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvar_names <- describe(file, sds = TRUE)\n\nhead(var_names)\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n| id|name                                                                                                                                                                          |var                                                           |desc                                                                                     | nrow| ncol| nlyr|\n|--:|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:-------------------------------------------------------------|:----------------------------------------------------------------------------------------|----:|----:|----:|\n|  1|HDF5:\"/media/LaCie16TB/work/projects/documentation/read_rs_product/data/AMSR_U2_L3_SeaIce12km_B04_20140314.he5\"://HDFEOS/GRIDS/NpPolarGrid12km/Data_Fields/SI_12km_NH_18H_ASC |//HDFEOS/GRIDS/NpPolarGrid12km/Data_Fields/SI_12km_NH_18H_ASC |[896x608] //HDFEOS/GRIDS/NpPolarGrid12km/Data_Fields/SI_12km_NH_18H_ASC (32-bit integer) |  896|  608|    1|\n|  2|HDF5:\"/media/LaCie16TB/work/projects/documentation/read_rs_product/data/AMSR_U2_L3_SeaIce12km_B04_20140314.he5\"://HDFEOS/GRIDS/NpPolarGrid12km/Data_Fields/SI_12km_NH_18H_DAY |//HDFEOS/GRIDS/NpPolarGrid12km/Data_Fields/SI_12km_NH_18H_DAY |[896x608] //HDFEOS/GRIDS/NpPolarGrid12km/Data_Fields/SI_12km_NH_18H_DAY (32-bit integer) |  896|  608|    1|\n|  3|HDF5:\"/media/LaCie16TB/work/projects/documentation/read_rs_product/data/AMSR_U2_L3_SeaIce12km_B04_20140314.he5\"://HDFEOS/GRIDS/NpPolarGrid12km/Data_Fields/SI_12km_NH_18H_DSC |//HDFEOS/GRIDS/NpPolarGrid12km/Data_Fields/SI_12km_NH_18H_DSC |[896x608] //HDFEOS/GRIDS/NpPolarGrid12km/Data_Fields/SI_12km_NH_18H_DSC (32-bit integer) |  896|  608|    1|\n|  4|HDF5:\"/media/LaCie16TB/work/projects/documentation/read_rs_product/data/AMSR_U2_L3_SeaIce12km_B04_20140314.he5\"://HDFEOS/GRIDS/NpPolarGrid12km/Data_Fields/SI_12km_NH_18V_ASC |//HDFEOS/GRIDS/NpPolarGrid12km/Data_Fields/SI_12km_NH_18V_ASC |[896x608] //HDFEOS/GRIDS/NpPolarGrid12km/Data_Fields/SI_12km_NH_18V_ASC (32-bit integer) |  896|  608|    1|\n|  5|HDF5:\"/media/LaCie16TB/work/projects/documentation/read_rs_product/data/AMSR_U2_L3_SeaIce12km_B04_20140314.he5\"://HDFEOS/GRIDS/NpPolarGrid12km/Data_Fields/SI_12km_NH_18V_DAY |//HDFEOS/GRIDS/NpPolarGrid12km/Data_Fields/SI_12km_NH_18V_DAY |[896x608] //HDFEOS/GRIDS/NpPolarGrid12km/Data_Fields/SI_12km_NH_18V_DAY (32-bit integer) |  896|  608|    1|\n|  6|HDF5:\"/media/LaCie16TB/work/projects/documentation/read_rs_product/data/AMSR_U2_L3_SeaIce12km_B04_20140314.he5\"://HDFEOS/GRIDS/NpPolarGrid12km/Data_Fields/SI_12km_NH_18V_DSC |//HDFEOS/GRIDS/NpPolarGrid12km/Data_Fields/SI_12km_NH_18V_DSC |[896x608] //HDFEOS/GRIDS/NpPolarGrid12km/Data_Fields/SI_12km_NH_18V_DSC (32-bit integer) |  896|  608|    1|\n\n</div>\n:::\n\n```{.r .cell-code}\nlayer <- var_names[[\"var\"]][grepl(\"SI_12km_NH_ICECON_DAY\", var_names[[\"var\"]], fixed = TRUE)]\n\nlayer\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"//HDFEOS/GRIDS/NpPolarGrid12km/Data_Fields/SI_12km_NH_ICECON_DAY\"\n```\n\n\n:::\n\n```{.r .cell-code}\nice_layer <- rast(file, subds = layer)\n\nice_layer\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nclass       : SpatRaster \ndimensions  : 896, 608, 1  (nrow, ncol, nlyr)\nresolution  : 12500, 12500  (x, y)\nextent      : -3850000, 3750000, -5350000, 5850000  (xmin, xmax, ymin, ymax)\ncoord. ref. : +proj=stere +lat_0=90 +lat_ts=70 +lon_0=-45 +x_0=0 +y_0=0 +R=6378273 +units=m +no_defs \nsource      : AMSR_U2_L3_SeaIce12km_B04_20140314.he5://SI_12km_NH_ICECON_DAY \nvarname     : SI_12km_NH_ICECON_DAY \nname        : SI_12km_NH_ICECON_DAY \n```\n\n\n:::\n:::\n\n\n\n\n\nWhy are the dimensions different?\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndim(r)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 897 608   1\n```\n\n\n:::\n\n```{.r .cell-code}\ndim(ice_layer)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 896 608   1\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(ice_layer)\n```\n\n::: {.cell-output-display}\n![](03_he5_files/figure-html/unnamed-chunk-10-1.png)\n:::\n:::\n",
    "supporting": [
      "03_he5_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}